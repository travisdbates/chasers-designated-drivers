---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navigation from '../../components/Navigation.astro';
import PlanSummary from '../../components/PlanSummary.astro';
import SecurePaymentForm from '../../components/SecurePaymentForm.astro';
import { MEMBERSHIP_PLANS, getPlansByCategory } from '../../config/plans.ts';

const allPlans = Object.fromEntries(
  getPlansByCategory('individual').map(plan => [plan.id, plan])
);

// Get plan from URL parameter, default to 'individual' if not specified
const url = new URL(Astro.request.url);
const planParam = url.searchParams.get('plan') || 'individual';
const selectedPlan = allPlans[planParam] || allPlans['individual'];
---

<BaseLayout 
  title={`Checkout - ${selectedPlan.name} | Chasers DD`}
  description={`Complete your ${selectedPlan.name} membership signup with secure payment processing.`}
  keywords="checkout, payment, membership signup, secure payment"
>
  <Navigation />
  
  <main class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-16">
    <div class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-4">
      <!-- Page Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          <span class="font-serif">Secure</span>
          <span class="text-gold-primary ml-3">Checkout</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
          Complete your membership signup with our secure payment system
        </p>
      </div>

      <!-- Plan Summary Section -->
      <PlanSummary plan={selectedPlan} />

      <!-- Secure Payment Form -->
      <div class="max-w-4xl mx-auto">
        <SecurePaymentForm 
          planId={selectedPlan.id}
          plan={selectedPlan} 
          onBack="goBackToMembership"
        />
      </div>
    </div>
  </main>
</BaseLayout>

<script define:vars={{ allPlans }}>
  // Custom back handler for this page
  window.goBackToMembership = () => {
    window.location.href = '/membership';
  };

  // Handle dynamic plan selection based on URL parameter
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const planParam = urlParams.get('plan') || 'individual';

    console.log('Client-side plan parameter:', planParam);

    if (allPlans[planParam]) {
      const selectedPlan = allPlans[planParam];
      console.log('Updating to plan:', selectedPlan.name, selectedPlan.price);

      // Update the plan name
      const nameElements = document.querySelectorAll('[data-plan-name]');
      nameElements.forEach(el => el.textContent = selectedPlan.name);

      // Update the plan description
      const descElements = document.querySelectorAll('[data-plan-description]');
      descElements.forEach(el => el.textContent = selectedPlan.description);

      // Update the plan price
      const priceElements = document.querySelectorAll('[data-plan-price]');
      priceElements.forEach(el => el.textContent = selectedPlan.price);

      // Update the plan subtext
      const subtextElements = document.querySelectorAll('[data-plan-subtext]');
      subtextElements.forEach(el => el.textContent = selectedPlan.priceSubtext);

      // Update the popular badge
      const popularElements = document.querySelectorAll('[data-plan-popular]');
      popularElements.forEach(el => {
        el.textContent = selectedPlan.popular ? 'Most Popular' : 'Selected Plan';
      });

      // Update page title
      document.title = `Checkout - ${selectedPlan.name} | Chasers DD`;
    }
  });
</script>