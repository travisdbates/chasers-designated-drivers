---
// This is the admin panel page that will check authentication
// and show either login form or pricing editor
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Chasers DD</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Login Form (shown initially) -->
        <div id="login-form" class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8">
            <h1 class="text-2xl font-bold mb-6 text-center">Admin Login</h1>
            <form id="login" class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
                        Password
                    </label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter admin password"
                    />
                </div>
                <div id="login-error" class="text-red-600 text-sm hidden"></div>
                <button
                    type="submit"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors"
                >
                    Login
                </button>
            </form>
        </div>

        <!-- Admin Panel (shown after login) -->
        <div id="admin-panel" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">Pricing Management</h1>
                        <div class="flex gap-3">
                            <button
                                id="view-history-btn"
                                class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors"
                            >
                                View History
                            </button>
                            <button
                                id="logout-btn"
                                class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors"
                            >
                                Logout
                            </button>
                        </div>
                    </div>

                    <!-- Pricing Form -->
                    <div id="pricing-form-container">
                        <p class="text-gray-500">Loading pricing data...</p>
                    </div>

                    <div id="save-status" class="mt-4 hidden"></div>

                    <!-- History Modal -->
                    <div id="history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold">Pricing Change History</h2>
                                    <button
                                        id="close-history-btn"
                                        class="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                    >
                                        &times;
                                    </button>
                                </div>
                            </div>
                            <div id="history-content" class="p-6 overflow-y-auto max-h-[calc(80vh-100px)]">
                                <p class="text-gray-500">Loading history...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSha = null;
        let pricingData = null;

        // Check if already authenticated
        async function checkAuth() {
            try {
                const response = await fetch('/api/admin/get-pricing');
                if (response.ok) {
                    // Already authenticated
                    await loadAdminPanel();
                }
            } catch (error) {
                // Not authenticated, show login form
            }
        }

        // Handle login
        document.getElementById('login')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const password = formData.get('password');
            const errorEl = document.getElementById('login-error');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Disable submit button during request
            if (submitBtn) submitBtn.disabled = true;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok) {
                    await loadAdminPanel();
                } else {
                    if (errorEl) {
                        errorEl.textContent = data.error || 'Login failed';
                        errorEl.classList.remove('hidden');
                    }

                    // If rate limited, disable form for the retry duration
                    if (response.status === 429 && data.retryAfter) {
                        const retrySeconds = data.retryAfter;
                        let countdown = retrySeconds;

                        const interval = setInterval(() => {
                            countdown--;
                            if (submitBtn) {
                                submitBtn.textContent = `Locked (${Math.ceil(countdown / 60)}m ${countdown % 60}s)`;
                            }
                            if (countdown <= 0) {
                                clearInterval(interval);
                                if (submitBtn) {
                                    submitBtn.textContent = 'Login';
                                    submitBtn.disabled = false;
                                }
                            }
                        }, 1000);
                        return; // Don't re-enable button
                    }
                }
            } catch (error) {
                if (errorEl) {
                    errorEl.textContent = 'An error occurred';
                    errorEl.classList.remove('hidden');
                }
            } finally {
                // Re-enable submit button
                if (submitBtn && !submitBtn.textContent.includes('Locked')) {
                    submitBtn.disabled = false;
                }
            }
        });

        // Handle logout
        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Handle view history
        document.getElementById('view-history-btn')?.addEventListener('click', async () => {
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');

            if (modal && content) {
                modal.classList.remove('hidden');
                content.innerHTML = '<p class="text-gray-500">Loading history...</p>';

                try {
                    const response = await fetch('/api/admin/pricing-history');
                    const data = await response.json();

                    if (response.ok) {
                        renderHistory(data.history);
                    } else {
                        content.innerHTML = '<p class="text-red-600">Failed to load history</p>';
                    }
                } catch (error) {
                    content.innerHTML = '<p class="text-red-600">Error loading history</p>';
                }
            }
        });

        // Handle close history modal
        document.getElementById('close-history-btn')?.addEventListener('click', () => {
            document.getElementById('history-modal')?.classList.add('hidden');
        });

        // Close modal on background click
        document.getElementById('history-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'history-modal') {
                document.getElementById('history-modal')?.classList.add('hidden');
            }
        });

        // Load admin panel
        async function loadAdminPanel() {
            try {
                const response = await fetch('/api/admin/get-pricing');
                if (!response.ok) {
                    throw new Error('Failed to load pricing');
                }

                const data = await response.json();
                pricingData = data.pricing;
                currentSha = data.sha;

                // Show admin panel, hide login
                document.getElementById('login-form')?.classList.add('hidden');
                document.getElementById('admin-panel')?.classList.remove('hidden');

                // Render pricing form
                renderPricingForm(pricingData);
            } catch (error) {
                console.error('Error loading admin panel:', error);
            }
        }

        // Render pricing form
        function renderPricingForm(pricing) {
            const container = document.getElementById('pricing-form-container');
            if (!container) return;

            const planNames = {
                'standard-individual': 'Standard Individual',
                'individual': 'Individual Premier',
                'joint': 'Joint Plan',
                'joint-premier': 'Joint Premier',
                'family': 'Friends & Family',
                'business': 'Business Plan',
                'business-premier': 'Business Premier',
                'corporate': 'Corporate Premier'
            };

            const form = document.createElement('form');
            form.id = 'pricing-form';
            form.className = 'space-y-6';

            for (const [planId, planData] of Object.entries(pricing)) {
                const planName = planNames[planId] || planId;

                const planSection = document.createElement('div');
                planSection.className = 'border-b border-gray-200 pb-4';
                planSection.innerHTML = `
                    <h3 class="text-lg font-semibold mb-3">
                        ${planName}
                        <span id="${planId}-current-price" class="text-gray-600 font-normal ml-2" data-original-price="${planData.priceNumeric}">
                            - Current Price: $${planData.priceNumeric.toFixed(2)}
                        </span>
                        <span id="${planId}-change-indicator" class="font-normal ml-2 hidden"></span>
                    </h3>
                    <div class="max-w-sm">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            New Monthly Subscription Price ($)
                        </label>
                        <input
                            type="number"
                            step="0.01"
                            min="0"
                            name="${planId}-price"
                            id="${planId}-price-input"
                            value="${planData.priceNumeric}"
                            data-plan-id="${planId}"
                            data-original-price="${planData.priceNumeric}"
                            class="price-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        />
                    </div>
                `;
                form.appendChild(planSection);
            }

            // Add submit button
            const submitDiv = document.createElement('div');
            submitDiv.className = 'pt-4';
            submitDiv.innerHTML = `
                <button
                    type="submit"
                    class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors font-semibold"
                >
                    Save Pricing & Commit to GitHub
                </button>
            `;
            form.appendChild(submitDiv);

            // Handle form submission
            form.addEventListener('submit', handlePricingUpdate);

            container.innerHTML = '';
            container.appendChild(form);

            // Add event listeners for price change indicators
            setupPriceChangeIndicators();
        }

        // Setup price change indicators
        function setupPriceChangeIndicators() {
            const priceInputs = document.querySelectorAll('.price-input');

            priceInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const planId = e.target.dataset.planId;
                    const originalPrice = parseFloat(e.target.dataset.originalPrice);
                    const newPrice = parseFloat(e.target.value);

                    updatePriceChangeDisplay(planId, originalPrice, newPrice);
                });
            });
        }

        // Update price change display
        function updatePriceChangeDisplay(planId, originalPrice, newPrice) {
            const currentPriceEl = document.getElementById(`${planId}-current-price`);
            const changeIndicatorEl = document.getElementById(`${planId}-change-indicator`);

            if (!currentPriceEl || !changeIndicatorEl) return;

            // If price is unchanged or invalid, reset display
            if (!newPrice || newPrice === originalPrice || isNaN(newPrice)) {
                currentPriceEl.className = 'text-gray-600 font-normal ml-2';
                currentPriceEl.style.textDecoration = 'none';
                changeIndicatorEl.classList.add('hidden');
                return;
            }

            // Calculate changes
            const dollarChange = newPrice - originalPrice;
            const percentChange = ((dollarChange / originalPrice) * 100).toFixed(1);

            // Determine color (green for increase, red for decrease)
            const isIncrease = dollarChange > 0;
            const color = isIncrease ? 'text-green-600' : 'text-red-600';
            const sign = isIncrease ? '+' : '';

            // Update current price display (strikethrough + color)
            currentPriceEl.className = `${color} font-normal ml-2`;
            currentPriceEl.style.textDecoration = 'line-through';

            // Update change indicator
            changeIndicatorEl.className = `${color} font-medium ml-2`;
            changeIndicatorEl.textContent = `${sign}$${Math.abs(dollarChange).toFixed(2)} (${sign}${percentChange}%)`;
            changeIndicatorEl.classList.remove('hidden');
        }

        // Handle pricing update
        async function handlePricingUpdate(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Build updated pricing object
            const updatedPricing = {};
            for (const planId in pricingData) {
                updatedPricing[planId] = {
                    priceNumeric: parseFloat(formData.get(`${planId}-price`))
                };
            }

            const statusEl = document.getElementById('save-status');
            if (statusEl) {
                statusEl.textContent = 'Saving and committing to GitHub...';
                statusEl.className = 'mt-4 p-4 bg-blue-100 text-blue-800 rounded';
                statusEl.classList.remove('hidden');
            }

            try {
                const response = await fetch('/api/admin/update-pricing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pricing: updatedPricing,
                        sha: currentSha
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (statusEl) {
                        statusEl.textContent = 'Pricing updated successfully! Changes committed to GitHub. The site will rebuild in 1-2 minutes.';
                        statusEl.className = 'mt-4 p-4 bg-green-100 text-green-800 rounded';
                    }
                    // Reload pricing data to get new SHA
                    setTimeout(() => loadAdminPanel(), 2000);
                } else {
                    throw new Error(data.error || 'Update failed');
                }
            } catch (error) {
                if (statusEl) {
                    statusEl.textContent = `Error: ${error.message}`;
                    statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded';
                }
            }
        }

        // Render pricing history
        function renderHistory(history) {
            const content = document.getElementById('history-content');
            if (!content) return;

            if (!history || history.length === 0) {
                content.innerHTML = '<p class="text-gray-500">No pricing changes found</p>';
                return;
            }

            const planNames = {
                'standard-individual': 'Standard Individual',
                'individual': 'Individual Premier',
                'joint': 'Joint Plan',
                'joint-premier': 'Joint Premier',
                'family': 'Friends & Family',
                'business': 'Business Plan',
                'business-premier': 'Business Premier',
                'corporate': 'Corporate Premier'
            };

            const historyHTML = history.map((entry, index) => {
                const date = new Date(entry.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Build changes list
                const changesHTML = entry.changes.map(change => {
                    const planName = planNames[change.planId] || change.planId;

                    if (change.type === 'initial') {
                        return `
                            <div class="text-sm">
                                <span class="font-medium">${planName}:</span>
                                <span class="text-gray-600">Initial price $${change.newPrice.toFixed(2)}</span>
                            </div>
                        `;
                    } else if (change.type === 'changed') {
                        const isIncrease = change.dollarChange > 0;
                        const color = isIncrease ? 'text-green-600' : 'text-red-600';
                        const sign = isIncrease ? '+' : '';

                        return `
                            <div class="text-sm flex items-center gap-2">
                                <span class="font-medium">${planName}:</span>
                                <span class="${color} line-through">$${change.previousPrice.toFixed(2)}</span>
                                <span class="text-gray-400">â†’</span>
                                <span class="font-semibold">$${change.newPrice.toFixed(2)}</span>
                                <span class="${color} font-medium">
                                    ${sign}$${Math.abs(change.dollarChange).toFixed(2)}
                                    (${sign}${change.percentChange}%)
                                </span>
                            </div>
                        `;
                    } else if (change.type === 'added') {
                        return `
                            <div class="text-sm">
                                <span class="font-medium">${planName}:</span>
                                <span class="text-green-600">Added at $${change.newPrice.toFixed(2)}</span>
                            </div>
                        `;
                    } else if (change.type === 'removed') {
                        return `
                            <div class="text-sm">
                                <span class="font-medium">${planName}:</span>
                                <span class="text-red-600">Removed (was $${change.previousPrice.toFixed(2)})</span>
                            </div>
                        `;
                    }
                    return '';
                }).join('');

                return `
                    <div class="border-l-4 ${index === 0 ? 'border-blue-500' : 'border-gray-300'} pl-4 pb-6 relative">
                        <div class="absolute -left-2 top-0 w-3 h-3 rounded-full ${index === 0 ? 'bg-blue-500' : 'bg-gray-300'}"></div>
                        <div class="text-xs text-gray-500 mb-1">${formattedDate}</div>
                        <div class="font-medium text-gray-800 mb-2">${entry.message}</div>
                        <div class="space-y-1 bg-gray-50 p-3 rounded">
                            ${changesHTML}
                        </div>
                        <div class="text-xs text-gray-400 mt-2">Commit: ${entry.hash}</div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="space-y-4">
                    ${historyHTML}
                </div>
            `;
        }

        // Check auth on page load
        checkAuth();
    </script>
</body>
</html>
